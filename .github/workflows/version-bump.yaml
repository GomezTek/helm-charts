name: Bump Chart Version

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version increment type (major, minor, patch)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      branch:
        description: 'Branch to create for version bump'
        required: true
        default: 'version-bump'

env:
  CHART_DIR: gtk-mesa-chart

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Create Version Bump Branch
        run: |
          git checkout -b ${{ github.event.inputs.branch }}

      - name: Get Current Version
        id: current_version
        run: |
          CURRENT_VERSION=$(yq '.version' ${{ env.CHART_DIR }}/Chart.yaml)
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT

      - name: Bump Version
        id: bump_version
        run: |
          CURRENT_VERSION=${{ steps.current_version.outputs.current_version }}
          VERSION_TYPE=${{ github.event.inputs.version_type }}
          
          # Split version into parts
          IFS='.' read -r major minor patch <<< "${CURRENT_VERSION}"
          
          case "${VERSION_TYPE}" in
            major)
              NEW_VERSION="$((major + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="${major}.$((minor + 1)).0"
              ;;
            patch)
              NEW_VERSION="${major}.${minor}.$((patch + 1))"
              ;;
          esac
          
          # Update Chart.yaml
          yq -i '.version = "'${NEW_VERSION}'"' ${{ env.CHART_DIR }}/Chart.yaml
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT

      - name: Update AppVersion if Major Version
        if: github.event.inputs.version_type == 'major'
        run: |
          NEW_VERSION=${{ steps.bump_version.outputs.new_version }}
          yq -i '.appVersion = "'${NEW_VERSION}'"' ${{ env.CHART_DIR }}/Chart.yaml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          title: 'chore: bump chart version to ${{ steps.bump_version.outputs.new_version }}'
          body: |
            Automated version bump from ${{ steps.current_version.outputs.current_version }} to ${{ steps.bump_version.outputs.new_version }}
            
            Changes:
            - Updated Chart version
            - Updated AppVersion (if major version bump)
            
            This PR was created automatically by the version bump workflow.
          branch: ${{ github.event.inputs.branch }}
          base: master
          labels: version-bump
          commit-message: 'chore: bump chart version to ${{ steps.bump_version.outputs.new_version }}'
          delete-branch: true
