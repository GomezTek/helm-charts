name: Release Helm Chart

on:
  push:
    branches:
      - main
      - 'release/*'
    paths:
      - 'mesa-os/**'
      - '.github/workflows/helm-release.yaml'
  workflow_dispatch:

env:
  CHART_DIR: mesa-os
  REGISTRY: ghcr.io/${{ github.repository_owner }}

jobs:
  chart-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.2

      - name: Add Helm repos
        run: |
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo update

      - name: Build dependencies
        run: |
          cd ${{ env.CHART_DIR }}
          helm dependency build

      - name: Run helm lint
        run: |
          helm lint ${{ env.CHART_DIR }}

      - name: Run helm template
        run: |
          helm template test ${{ env.CHART_DIR }}

  debug-info:
    needs: chart-test
    runs-on: ubuntu-latest
    steps:
      - name: Debug Info
        run: |
          echo "Branch ref: ${{ github.ref }}"
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"

  release:
    needs: [chart-test, debug-info]
    runs-on: ubuntu-latest
    if: ${{ success() }}
    permissions:
      packages: write
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Yq
        run: |
          YQ_VERSION="v4.40.5"  # Pin to specific version for reliability
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Add Helm repos
        run: |
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo update

      - name: Set Chart Version
        id: set_version
        run: |
          # Get base version from Chart.yaml
          CHART_VERSION=$(yq eval '.version' ${{ env.CHART_DIR }}/Chart.yaml)
          
          if [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
            # For release branches, append commit SHA
            SHA=$(git rev-parse --short HEAD)
            NEW_VERSION="${CHART_VERSION}-${SHA}"
          else
            # For main branch, use version as is
            NEW_VERSION="${CHART_VERSION}"
          fi
          
          echo "Setting version to: ${NEW_VERSION}"
          yq eval -i '.version = "'${NEW_VERSION}'"' ${{ env.CHART_DIR }}/Chart.yaml
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT

      - name: Build and Push Chart
        env:
          HELM_EXPERIMENTAL_OCI: 1
        run: |
          VERSION=${{ steps.set_version.outputs.version }}
          CHART_NAME=mesa-os  # Updated chart name to mesa-os
          # Convert repository owner to lowercase for GHCR
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          echo "Building dependencies..."
          helm dependency build ${{ env.CHART_DIR }}
          
          echo "Logging into GHCR..."
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "Packaging and pushing chart ${CHART_NAME}:${VERSION}..."
          helm package ${{ env.CHART_DIR }}
          helm push ${CHART_NAME}-${VERSION}.tgz oci://ghcr.io/${REPO_OWNER}/charts
          
          echo "Successfully pushed chart to GHCR"

      - name: Create Release and Tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Set git user for tagging
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"

          VERSION=${{ steps.set_version.outputs.version }}
          TAG="mesa-os-${VERSION}"
          
          # Check if tag exists and delete it if needed
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, deleting..."
            git tag -d $TAG
            git push origin :refs/tags/$TAG
          fi

          # Delete release if it exists
          if gh release view $TAG >/dev/null 2>&1; then
            echo "Release $TAG already exists, deleting..."
            gh release delete $TAG -y
          fi
          
          # Create a tag
          git tag $TAG
          git push origin $TAG
          
          # Generate release notes
          RELEASE_NOTES="## Mesa OS Chart ${VERSION}\n\nRelease notes for version ${VERSION}."
          echo "$RELEASE_NOTES" > release-notes.md
          gh release create $TAG -F release-notes.md